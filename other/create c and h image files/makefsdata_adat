#!/usr/bin/perl

open(OUTPUT, "> httpd-fsdata-webserver.h");
print(OUTPUT "/********************************************************************************\n");
print(OUTPUT "  httpd-fsdata-webserver.h                                                       \n");
print(OUTPUT "                                                                                 \n");
print(OUTPUT "  This header file has been generated by the perl-script makefsdata_adat         \n");
print(OUTPUT "                                                                                 \n");
print(OUTPUT "  All files in the directory httpd-fs are packed in this header-file.            \n");
print(OUTPUT "                                                                                 \n");
print(OUTPUT "  (Install Strawberry Perl from http://strawberryperl.com/                       \n");
print(OUTPUT "   and start the script on command-line with the command perl makefsdata_adat)   \n");
print(OUTPUT "*********************************************************************************/\n");
print(OUTPUT "\n");
print(OUTPUT "#ifndef _httpd_fsdata_webserver_H_\n");
print(OUTPUT "#define _httpd_fsdata_webserver_H_\n");
print(OUTPUT "\n");
print(OUTPUT "#include <stddef.h>\n\n");

chdir("httpd-fs");

opendir(DIR, ".");
@files =  grep { !/^\./ && !/(CVS|~)/ } readdir(DIR);
closedir(DIR);

foreach $file (@files) {  
   
    if(-d $file && $file !~ /^\./) {
	print "Processing directory $file\n";
	opendir(DIR, $file);
	@newfiles =  grep { !/^\./ && !/(CVS|~)/ } readdir(DIR);
	closedir(DIR);
	printf "Adding files @newfiles\n";
	@files = (@files, map { $_ = "$file/$_" } @newfiles);
	next;
    }
}

foreach $file (@files) {
    if(-f $file) {
	
	print "Adding file $file\n";
	
	open(FILE, $file) || die "Could not open file $file\n";

	$file =~ s-^-/-;
	$fvar = $file;
	$fvar =~ s-/-_-g;
	$fvar =~ s-\.-_-g;
	# for AVR, add PROGMEM here
	print(OUTPUT "static const unsigned char data".$fvar."[] = {\n");
		
	$len = 0;
	while(read(FILE, $data, 1)) {
	    unpack("C", $data);
	    $len = $len + 1;
	}
	
	seek(FILE,0,0);
	
	$count = 0;
	$i = 0;
	while(read(FILE, $data, 1)) {
	    $count = $count + 1;
	    if($i == 0) {
		print(OUTPUT "\t");
	    }
	    if ($len == $count) {
	       printf(OUTPUT "%#02x ", unpack("C", $data));
	    }
	    else {
	       printf(OUTPUT "%#02x, ", unpack("C", $data));
	    }
	    $i++;
	    if($i == 10) {
		print(OUTPUT "\n");
		$i = 0;
	    }
	}
		
	print(OUTPUT "};\n\n");
	close(FILE);
	push(@fvars, $fvar);
	push(@pfiles, $file);
    }
}

for($i = 0; $i < @fvars; $i++) {
    $file = $pfiles[$i];
    $fvar = $fvars[$i];

    if($i == 0) {
        $prevfile = "NULL";
    } else {
        $prevfile = "file" . $fvars[$i - 1];
    }
    print(OUTPUT "const struct httpd_fsdata_file file".$fvar."[] = {{$prevfile, data$fvar, ");
    print(OUTPUT "data$fvar + ". (length($file) + 1) .", ");
    print(OUTPUT "sizeof(data$fvar) - ". (length($file) + 1) ."}};\n\n");
}

print(OUTPUT "#define HTTPD_FS_ROOT file$fvars[$i - 1]\n\n");
print(OUTPUT "#define HTTPD_FS_NUMFILES $i\n");
print(OUTPUT "\n");
print(OUTPUT "#endif");

